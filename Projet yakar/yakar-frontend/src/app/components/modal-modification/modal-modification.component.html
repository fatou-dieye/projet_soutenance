<!--modal modifier utilisateur-->
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="logo-title">
        <img src="/yakar-logo.png" alt="Yakar Logo" class="logo">
        <h2>Modifier un utilisateur</h2>
      </div>
      <button type="button" class="close-button" (click)="closeModal()" aria-label="Fermer">✕</button>
    </div>

    <div *ngIf="isLoading" class="loading-spinner">
      Chargement des données...
    </div>

    <form #userForm="ngForm" (ngSubmit)="onSubmit(userForm)" class="modal-form" *ngIf="!isLoading">
      <!-- Nom -->
      <div class="form-group">
        <label for="nom">Nom<span class="required">*</span></label>
        <input 
          type="text" 
          [(ngModel)]="utilisateur.nom" 
          name="nom" 
          required 
          minlength="2" 
          maxlength="50" 
          pattern="[a-zA-ZÀ-ÿ\s-]+"
          #nomInput="ngModel"
          [class.is-invalid]="nomInput.invalid && (nomInput.dirty || nomInput.touched)"
        >
        <div *ngIf="nomInput.invalid && (nomInput.dirty || nomInput.touched)" class="error-validation">
          <small *ngIf="nomInput.errors?.['required']">Le nom est obligatoire.</small>
          <small *ngIf="nomInput.errors?.['minlength']">Le nom doit avoir au moins 2 caractères.</small>
          <small *ngIf="nomInput.errors?.['pattern']">Le nom ne doit contenir que des lettres, espaces et tirets.</small>
        </div>
      </div>

      <!-- Prénom -->
      <div class="form-group">
        <label for="prenom">Prénom<span class="required">*</span></label>
        <input 
          type="text" 
          [(ngModel)]="utilisateur.prenom" 
          name="prenom" 
          required 
          minlength="2" 
          maxlength="50" 
          pattern="[a-zA-ZÀ-ÿ\s-]+"
          #prenomInput="ngModel"
          [class.is-invalid]="prenomInput.invalid && (prenomInput.dirty || prenomInput.touched)"
        >
        <div *ngIf="prenomInput.invalid && (prenomInput.dirty || prenomInput.touched)" class="error-validation">
          <small *ngIf="prenomInput.errors?.['required']">Le prénom est obligatoire.</small>
          <small *ngIf="prenomInput.errors?.['minlength']">Le prénom doit avoir au moins 2 caractères.</small>
          <small *ngIf="prenomInput.errors?.['pattern']">Le prénom ne doit contenir que des lettres, espaces et tirets.</small>
        </div>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Email<span class="required">*</span></label>
        <input 
          type="email" 
          id="email"
          [(ngModel)]="utilisateur.email" 
          name="email" 
          required 
          pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
          #emailInput="ngModel"
          [class.is-invalid]="emailInput.invalid && (emailInput.dirty || emailInput.touched)"
          placeholder="Entrer l'email"
        >
        <div *ngIf="emailInput.invalid && (emailInput.dirty || emailInput.touched)" class="error-validation">
          <small *ngIf="emailInput.errors?.['required']">L'email est obligatoire.</small>
          <small *ngIf="emailInput.errors?.['pattern']">Format d'email invalide.</small>
        </div>
      </div>

      <!-- Mot de passe -->
      <div class="form-group">
        <label for="mot_passe">Mot de passe</label>
        <div class="password-input">
          <input 
            [type]="showPassword ? 'text' : 'password'"
            id="mot_passe"
            [(ngModel)]="utilisateur.mot_passe" 
            name="mot_passe" 
            minlength="8"
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
            #motPasseInput="ngModel"
            [class.is-invalid]="motPasseInput.invalid && (motPasseInput.dirty || motPasseInput.touched)"
            placeholder="Laissez vide pour conserver l'ancien"
          >
          <button 
            type="button" 
            class="toggle-password" 
            (click)="showPassword = !showPassword"
            [attr.aria-label]="showPassword ? 'Masquer le mot de passe' : 'Afficher le mot de passe'"
          >
          <img  src="/oeil.png" alt="Eye Icon" style="width: 24px; height: 24px;  opacity: 0.3; margin-left: -100px;">
          </button>
        </div>
        <div *ngIf="motPasseInput.invalid && (motPasseInput.dirty || motPasseInput.touched)" class="error-validation">
          <small *ngIf="motPasseInput.errors?.['minlength']">Le mot de passe doit avoir au moins 8 caractères.</small>
          <small *ngIf="motPasseInput.errors?.['pattern']">Le mot de passe doit contenir au moins une majuscule, une minuscule, un chiffre et un caractère spécial.</small>
        </div>
      </div>

      <!-- Role -->
      <div class="form-group">
        <label for="role">Rôle<span class="required">*</span></label>
        <input
          type="text"
          id="role"
          [value]="utilisateur.role"
          name="role"
          readonly
          class="disabled-input"
          [attr.aria-label]="'Rôle actuel: ' + utilisateur.role">
      </div>

      <!-- Code secret -->
      <div class="form-group">
        <label for="code_secret">Code secret</label>
        <input 
          type="text"
          id="code_secret"
          [(ngModel)]="utilisateur.code_secret" 
          name="code_secret"
          pattern="^[0-9]{4}$"
          maxlength="4"
          #codeSecretInput="ngModel"
          [class.is-invalid]="codeSecretInput.invalid && (codeSecretInput.dirty || codeSecretInput.touched)"
          placeholder="Laissez vide pour conserver l'ancien"
          autocomplete="off"
        >
        <div *ngIf="codeSecretInput.invalid && (codeSecretInput.dirty || codeSecretInput.touched)" class="error-validation">
          <small *ngIf="codeSecretInput.errors?.['pattern']">Le code secret doit comporter exactement 4 chiffres.</small>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="error-message" role="alert">
        {{ errorMessage }}
      </div>

      <!-- Submit Button -->
      <button 
        type="submit" 
        class="submit-button" 
        [disabled]="!userForm.valid || isSubmitting"
        [class.loading]="isSubmitting"
      >
        {{ isSubmitting ? 'Modification en cours...' : 'Modifier' }}
      </button>
    </form>
  </div>
</div>